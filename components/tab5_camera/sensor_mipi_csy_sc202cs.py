"""
Sensor SC202CS pour MIPI-CSI
Basé sur le driver Espressif SC202CS
"""
import esphome.codegen as cg
import esphome.config_validation as cv

# Registres SC202CS
SC202CS_REG_SENSOR_ID_H = 0x3107
SC202CS_REG_SENSOR_ID_L = 0x3108
SC202CS_REG_SLEEP_MODE = 0x0100
SC202CS_REG_DIG_COARSE_GAIN = 0x3e06
SC202CS_REG_DIG_FINE_GAIN = 0x3e07
SC202CS_REG_ANG_GAIN = 0x3e09
SC202CS_REG_SHUTTER_TIME_H = 0x3e00
SC202CS_REG_SHUTTER_TIME_M = 0x3e01
SC202CS_REG_SHUTTER_TIME_L = 0x3e02
SC202CS_REG_FLIP_MIRROR = 0x3221

SC202CS_PID = 0xeb52
SC202CS_DEFAULT_ADDR = 0x36

# Configuration 720P (1280x720@30fps)
REGLIST_720P = [
    (0x0103, 0x01),
    (0x0100, 0x00),
    (0x36e9, 0x80), (0x36ea, 0x06),
    (0x36eb, 0x0a), (0x36ec, 0x01),
    (0x36ed, 0x18), (0x36e9, 0x24),
    (0x301f, 0x18), (0x3031, 0x08),
    (0x3037, 0x00),
    # Fenêtre et résolution
    (0x3200, 0x00), (0x3201, 0xa0),  # Start X
    (0x3202, 0x00), (0x3203, 0xf0),  # Start Y
    (0x3204, 0x05), (0x3205, 0xa7),  # End X
    (0x3206, 0x03), (0x3207, 0xc7),  # End Y
    (0x3208, 0x05), (0x3209, 0x00),  # Width = 1280
    (0x320a, 0x02), (0x320b, 0xd0),  # Height = 720
    (0x3210, 0x00), (0x3211, 0x04),  # X offset
    (0x3212, 0x00), (0x3213, 0x04),  # Y offset
    # Réglages capteur
    (0x3301, 0xff), (0x3304, 0x68),
    (0x3306, 0x40), (0x3308, 0x08),
    (0x3309, 0xa8), (0x330b, 0xd0),
    (0x330c, 0x18), (0x330d, 0xff),
    (0x330e, 0x20), (0x331e, 0x59),
    (0x331f, 0x99), (0x3333, 0x10),
    (0x335e, 0x06), (0x335f, 0x08),
    (0x3364, 0x1f), (0x337c, 0x02),
    (0x337d, 0x0a), (0x338f, 0xa0),
    (0x3390, 0x01), (0x3391, 0x03),
    (0x3392, 0x1f), (0x3393, 0xff),
    (0x3394, 0xff), (0x3395, 0xff),
    (0x33a2, 0x04), (0x33ad, 0x0c),
    (0x33b1, 0x20), (0x33b3, 0x38),
    (0x33f9, 0x40), (0x33fb, 0x48),
    (0x33fc, 0x0f), (0x33fd, 0x1f),
    (0x349f, 0x03), (0x34a6, 0x03),
    (0x34a7, 0x1f), (0x34a8, 0x38),
    (0x34a9, 0x30), (0x34ab, 0xd0),
    (0x34ad, 0xd8), (0x34f8, 0x1f),
    (0x34f9, 0x20), (0x3630, 0xa0),
    (0x3631, 0x92), (0x3632, 0x64),
    (0x3633, 0x43), (0x3637, 0x49),
    (0x363a, 0x85), (0x363c, 0x0f),
    (0x3650, 0x31), (0x3670, 0x0d),
    (0x3674, 0xc0), (0x3675, 0xa0),
    (0x3676, 0xa0), (0x3677, 0x92),
    (0x3678, 0x96), (0x3679, 0x9a),
    (0x367c, 0x03), (0x367d, 0x0f),
    (0x367e, 0x01), (0x367f, 0x0f),
    (0x3698, 0x83), (0x3699, 0x86),
    (0x369a, 0x8c), (0x369b, 0x94),
    (0x36a2, 0x01), (0x36a3, 0x03),
    (0x36a4, 0x07), (0x36ae, 0x0f),
    (0x36af, 0x1f), (0x36bd, 0x22),
    (0x36be, 0x22), (0x36bf, 0x22),
    (0x36d0, 0x01), (0x370f, 0x02),
    (0x3721, 0x6c), (0x3722, 0x8d),
    (0x3725, 0xc5), (0x3727, 0x14),
    (0x3728, 0x04), (0x37b7, 0x04),
    (0x37b8, 0x04), (0x37b9, 0x06),
    (0x37bd, 0x07), (0x37be, 0x0f),
    (0x3901, 0x02), (0x3903, 0x40),
    (0x3905, 0x8d), (0x3907, 0x00),
    (0x3908, 0x41), (0x391f, 0x41),
    (0x3933, 0x80), (0x3934, 0x02),
    (0x3937, 0x6f), (0x393a, 0x01),
    (0x393d, 0x01), (0x393e, 0xc0),
    (0x39dd, 0x41),
    # Exposition et gain par défaut
    (0x3e00, 0x00), (0x3e01, 0x4d),
    (0x3e02, 0xc0), (0x3e09, 0x00),
    (0x4509, 0x28), (0x450d, 0x61),
]

# Table de gain absolu SC202CS (x1000 pour éviter les décimales)
GAIN_TABLE = [
    1000, 1031, 1063, 1094, 1125, 1156, 1188, 1219,
    1250, 1281, 1313, 1344, 1375, 1406, 1438, 1469,
    1500, 1531, 1563, 1594, 1625, 1656, 1688, 1719,
    1750, 1781, 1813, 1844, 1875, 1906, 1938, 1969,
    # 2X
    2000, 2062, 2126, 2188, 2250, 2312, 2376, 2438,
    2500, 2562, 2626, 2688, 2750, 2812, 2876, 2938,
    3000, 3062, 3126, 3188, 3250, 3312, 3376, 3438,
    3500, 3562, 3626, 3688, 3750, 3812, 3876, 3938,
    # 4X
    4000, 4124, 4252, 4376, 4500, 4624, 4752, 4876,
    5000, 5124, 5252, 5376, 5500, 5624, 5752, 5876,
    6000, 6124, 6252, 6376, 6500, 6624, 6752, 6876,
    7000, 7124, 7252, 7376, 7500, 7624, 7752, 7876,
    # 8X
    8000, 8248, 8504, 8752, 9000, 9248, 9504, 9752,
    10000, 10248, 10504, 10752, 11000, 11248, 11504, 11752,
    12000, 12248, 12504, 12752, 13000, 13248, 13504, 13752,
    14000, 14248, 14504, 14752, 15000, 15248, 15504, 15752,
    # 16X
    16000, 16496, 17008, 17504, 18000, 18496, 19008, 19504,
    20000, 20496, 21008, 21504, 22000, 22496, 23008, 23504,
    24000, 24496, 25008, 25504, 26000, 26496, 27008, 27504,
    28000, 28496, 29008, 29504, 30000, 30496, 31008, 31504,
    # 32X
    32000, 33008, 34000, 35008, 36000, 37008, 38000, 39008,
    40000, 41008, 42000, 43008, 44000, 45008, 46000, 47008,
    48000, 49008, 50000, 51008, 52000, 53008, 54000, 55008,
    56000, 57008, 58000, 59008, 60000, 61008, 62000, 63008,
]

# Map de gain [DIG_FINE, DIG_COARSE, ANALOG]
GAIN_MAP = [
    # 1X
    (0x80, 0x00, 0x00), (0x84, 0x00, 0x00), (0x88, 0x00, 0x00), (0x8c, 0x00, 0x00),
    (0x90, 0x00, 0x00), (0x94, 0x00, 0x00), (0x98, 0x00, 0x00), (0x9c, 0x00, 0x00),
    (0xa0, 0x00, 0x00), (0xa4, 0x00, 0x00), (0xa8, 0x00, 0x00), (0xac, 0x00, 0x00),
    (0xb0, 0x00, 0x00), (0xb4, 0x00, 0x00), (0xb8, 0x00, 0x00), (0xbc, 0x00, 0x00),
    (0xc0, 0x00, 0x00), (0xc4, 0x00, 0x00), (0xc8, 0x00, 0x00), (0xcc, 0x00, 0x00),
    (0xd0, 0x00, 0x00), (0xd4, 0x00, 0x00), (0xd8, 0x00, 0x00), (0xdc, 0x00, 0x00),
    (0xe0, 0x00, 0x00), (0xe4, 0x00, 0x00), (0xe8, 0x00, 0x00), (0xec, 0x00, 0x00),
    (0xf0, 0x00, 0x00), (0xf4, 0x00, 0x00), (0xf8, 0x00, 0x00), (0xfc, 0x00, 0x00),
    # 2X (analog 0x01)
    (0x80, 0x00, 0x01), (0x84, 0x00, 0x01), (0x88, 0x00, 0x01), (0x8c, 0x00, 0x01),
    (0x90, 0x00, 0x01), (0x94, 0x00, 0x01), (0x98, 0x00, 0x01), (0x9c, 0x00, 0x01),
    (0xa0, 0x00, 0x01), (0xa4, 0x00, 0x01), (0xa8, 0x00, 0x01), (0xac, 0x00, 0x01),
    (0xb0, 0x00, 0x01), (0xb4, 0x00, 0x01), (0xb8, 0x00, 0x01), (0xbc, 0x00, 0x01),
    (0xc0, 0x00, 0x01), (0xc4, 0x00, 0x01), (0xc8, 0x00, 0x01), (0xcc, 0x00, 0x01),
    (0xd0, 0x00, 0x01), (0xd4, 0x00, 0x01), (0xd8, 0x00, 0x01), (0xdc, 0x00, 0x01),
    (0xe0, 0x00, 0x01), (0xe4, 0x00, 0x01), (0xe8, 0x00, 0x01), (0xec, 0x00, 0x01),
    (0xf0, 0x00, 0x01), (0xf4, 0x00, 0x01), (0xf8, 0x00, 0x01), (0xfc, 0x00, 0x01),
    # Continuer pour 4X, 8X, 16X, 32X...
]

class SC202CSSensor:
    """Classe représentant le capteur SC202CS"""
    
    def __init__(self):
        self.pid = SC202CS_PID
        self.name = "SC202CS"
        self.default_address = SC202CS_DEFAULT_ADDR
        self.lanes = 1  # 1 lane MIPI
        self.bayer_pattern = 3  # BGGR
        self.lane_bitrate_mbps = 576
        
    def get_720p_config(self):
        """Retourne la config 720P"""
        return {
            'width': 1280,
            'height': 720,
            'fps': 30,
            'registers': REGLIST_720P,
            'color_type': 'RAW8',
            'output_type': 'RGB565',
        }
    
    def get_gain_table(self):
        """Retourne la table de gain"""
        return GAIN_TABLE
    
    def get_gain_registers(self, gain_index):
        """Retourne les valeurs de registres pour un index de gain"""
        if gain_index >= len(GAIN_MAP):
            gain_index = len(GAIN_MAP) - 1
        return GAIN_MAP[gain_index]


# Export pour utilisation dans tab5_camera
def get_sensor_config():
    sensor = SC202CSSensor()
    return {
        'name': sensor.name,
        'pid': sensor.pid,
        'address': sensor.default_address,
        'lanes': sensor.lanes,
        'bayer_pattern': sensor.bayer_pattern,
        'lane_bitrate_mbps': sensor.lane_bitrate_mbps,
        'config_720p': sensor.get_720p_config(),
        'gain_table': sensor.get_gain_table(),
    }
